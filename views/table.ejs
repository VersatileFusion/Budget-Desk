<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جدول مصارف</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Tahoma, sans-serif;
            background: #f8f9fa;
        }

        table {
            background: #fff;
        }

        th,
        td {
            text-align: center;
            vertical-align: middle;
            font-size: 13px !important;
            font-family: Tahoma, Arial, sans-serif !important;
        }

        th {
            background: #e9ecef;
        }

        .section-header {
            font-size: 16px;
            font-weight: bold;
            background: #f1f1f1;
        }

        .main-title {
            font-size: 15px !important;
            font-weight: bold;
        }

        .table,
        .table th,
        .table td {
            border: 1px solid #222 !important;
            border-collapse: collapse !important;
        }

        .table th,
        .table td {
            padding: 2px 4px !important;
        }

        .table tr {
            height: 22px !important;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {

            th,
            td {
                font-size: 11px !important;
                padding: 2px 2px !important;
            }

            .section-header {
                font-size: 13px;
            }

            .main-title {
                font-size: 12px !important;
            }

            .btn,
            .form-control {
                font-size: 13px !important;
                min-height: 36px;
            }

            .container {
                padding-left: 2px;
                padding-right: 2px;
            }
        }

        /* Make nav-tabs horizontally scrollable on mobile */
        .nav-tabs {
            overflow-x: auto;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .nav-tabs .nav-item {
            white-space: nowrap;
        }

        /* Hide scroll bar but allow scroll */
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body>
    <% if (typeof error !=='undefined' && error) { %>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                Swal.fire({
                    icon: 'error',
                    title: 'خطا',
                    text: '<%= error %>',
                    confirmButtonText: 'باشه'
                });
            });
        </script>
        <% } %>
            <script>
                function confirmDelete(form) {
                    Swal.fire({
                        title: 'حذف ردیف',
                        text: 'آیا از حذف این ردیف مطمئن هستید؟',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'بله، حذف کن',
                        cancelButtonText: 'انصراف'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                    return false;
                }
            </script>
            <div class="container mt-4">
                <div class="d-flex justify-content-end mb-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="islandDropdown"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <%= island %>
                        </button>
                        <ul class="dropdown-menu text-end" aria-labelledby="islandDropdown">
                            <% islands.forEach(function(name) { %>
                                <li>
                                    <a class="dropdown-item<%= island === name ? ' active' : '' %>"
                                        href="/?island=<%= encodeURIComponent(name) %>&sheet=<%= encodeURIComponent(sheet) %>">
                                        <%= name %>
                                    </a>
                                </li>
                                <% }); %>
                        </ul>
                    </div>
                </div>
                <div class="d-flex justify-content-end mb-3">
                    <ul class="nav nav-tabs w-100" style="direction: rtl;">
                        <% sheetNames.forEach(function(name) { %>
                            <li class="nav-item">
                                <a class="nav-link<%= sheet === name ? ' active' : '' %>"
                                    href="/?island=<%= encodeURIComponent(island) %>&sheet=<%= encodeURIComponent(name) %>">
                                    <%= name %>
                                </a>
                            </li>
                            <% }); %>
                    </ul>
                </div>
                <h2 class="mb-4 text-center">جدول <%= sheet %>
                </h2>
                <!-- Add Row Form -->
                <form class="mb-4" method="POST" action="/add-row" id="addRowForm">
                    <input type="hidden" name="island" value="<%= island %>">
                    <input type="hidden" name="sheet" value="<%= sheet %>">
                    <div class="table-responsive">
                        <table class="table table-bordered align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>کد ردیف</th>
                                    <th>عنوان</th>
                                    <th>عملکرد ۱۲ ماهه ۱۴۰۲</th>
                                    <th>مصوب ۱۴۰۳</th>
                                    <th>عملکرد ۷ ماهه ۱۴۰۳</th>
                                    <th>درصد تحقق عملکرد ۷ ماهه ۱۴۰۳</th>
                                    <th>اصلاحیه ۱۴۰۳</th>
                                    <th>درصد افزایش/کاهش اصلاحیه ۱۴۰۳ به مصوب ۱۴۰۳</th>
                                    <th>مصوب ۱۴۰۴</th>
                                    <th>درصد افزایش/کاهش مصوب ۱۴۰۴ به اصلاحیه ۱۴۰۳</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" class="form-control" name="code" id="codeInput"
                                            placeholder="کد ردیف"></td>
                                    <td><input type="text" class="form-control" name="title" id="titleInput"
                                            placeholder="عنوان" required></td>
                                    <td><input type="text" class="form-control" name="values[]" id="val0"></td>
                                    <td><input type="text" class="form-control" name="values[]" id="val1"></td>
                                    <td><input type="text" class="form-control" name="values[]" id="val2"></td>
                                    <td><input type="text" class="form-control" name="values[]" id="val3"></td>
                                    <td><input type="text" class="form-control" name="values[]" id="val4"></td>
                                    <td><input type="text" class="form-control" name="values[]" id="val5"></td>
                                    <td><input type="text" class="form-control" name="values[]" id="val6"></td>
                                    <td><input type="text" class="form-control" name="values[]" id="val7"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="form-check mt-2 mb-2">
                        <input class="form-check-input" type="checkbox" value="1" id="sectionHeaderCheck"
                            name="sectionHeader">
                        <label class="form-check-label" for="sectionHeaderCheck">
                            این ردیف، سرفصل است
                        </label>
                    </div>
                    <div class="mt-2 text-center">
                        <button type="submit" class="btn btn-success">افزودن ردیف</button>
                    </div>
                </form>
                <script>
                    document.getElementById('sectionHeaderCheck').addEventListener('change', function () {
                        var isHeader = this.checked;
                        document.getElementById('codeInput').disabled = isHeader;
                        for (var i = 0; i < 8; i++) {
                            document.getElementById('val' + i).disabled = isHeader;
                        }
                        document.getElementById('codeInput').required = !isHeader;
                    });
                </script>
                <!-- End Add Row Form -->
                <div class="table-responsive">
                    <table class="table table-bordered align-middle">
                        <thead>
                            <tr>
                                <th rowspan="2">کد ردیف</th>
                                <th rowspan="2">عنوان</th>
                                <th>عملکرد ۱۲ ماهه ۱۴۰۲</th>
                                <th>مصوب ۱۴۰۳</th>
                                <th>عملکرد ۷ ماهه ۱۴۰۳</th>
                                <th>درصد تحقق عملکرد ۷ ماهه ۱۴۰۳</th>
                                <th>اصلاحیه ۱۴۰۳</th>
                                <th>درصد افزایش/کاهش اصلاحیه ۱۴۰۳ به مصوب ۱۴۰۳</th>
                                <th>مصوب ۱۴۰۴</th>
                                <th>درصد افزایش/کاهش مصوب ۱۴۰۴ به اصلاحیه ۱۴۰۳</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% function getParentCode(code) { let codeStr=String(code); for (let i=codeStr.length - 1;
                                i>= 0; i--) {
                                if (codeStr[i] !== '0') {
                                return codeStr.substring(0, i) + '0'.repeat(codeStr.length - i);
                                }
                                }
                                return null;
                                }
                                function getDirectChildren(parentCode) {
                                return tableData.filter(function(row) {
                                return getParentCode(row.code) === String(parentCode);
                                });
                                }
                                function getSumOfColumn(parentCode, colIdx) {
                                var children = getDirectChildren(parentCode);
                                var sum = 0;
                                children.forEach(function(child) {
                                if (child.values && child.values[colIdx]) {
                                var val = parseFloat(child.values[colIdx]);
                                if (!isNaN(val)) {
                                sum += val;
                                }
                                }
                                });
                                return sum;
                                }
                                function hasDirectChildren(code) {
                                return getDirectChildren(code).length > 0;
                                }
                                function getCodeLevel(code) {
                                if (!code) return 0;
                                var codeStr = String(code);
                                var level = 0;
                                for (var i = codeStr.length - 2; i >= 0; i -= 2) {
                                if (codeStr.slice(i, i + 2) === '00') {
                                level++;
                                } else {
                                break;
                                }
                                }
                                return codeStr.length / 2 - level;
                                }
                                var editIndex = typeof editRowIndex !== 'undefined' ? editRowIndex : -1;
                                %>
                                <% tableData.forEach(function(row, rowIndex) { %>
                                    <% if (!row.code || isNaN(row.code)) { %>
                                        <tr>
                                            <td colspan="10" class="section-header">
                                                <%= row.title %>
                                            </td>
                                        </tr>
                                        <% } else if (editIndex===rowIndex) { %>
                                            <form method="POST" action="/edit-row">
                                                <input type="hidden" name="island" value="<%= island %>">
                                                <input type="hidden" name="sheet" value="<%= sheet %>">
                                                <tr>
                                                    <td><input type="text" name="code" value="<%= row.code %>"
                                                            class="form-control" required></td>
                                                    <td style="padding-right: <%= 20 * getCodeLevel(row.code) %>px;">
                                                        <input type="text" name="title" value="<%= row.title %>"
                                                            class="form-control" required>
                                                    </td>
                                                    <% for (var i=0; i < 8; i++) { %>
                                                        <td><input type="text" name="values[]"
                                                                value="<%= row.values && row.values[i] ? row.values[i] : '' %>"
                                                                class="form-control"></td>
                                                        <% } %>
                                                            <td><button type="submit"
                                                                    class="btn btn-success btn-sm">ذخیره</button></td>
                                                            <input type="hidden" name="rowIndex"
                                                                value="<%= rowIndex %>">
                                                </tr>
                                            </form>
                                            <% } else { %>
                                                <tr>
                                                    <td>
                                                        <%= row.code %>
                                                    </td>
                                                    <td style="padding-right: <%= 20 * getCodeLevel(row.code) %>px;">
                                                        <%= row.title %>
                                                    </td>
                                                    <% for (var i=0; i < 8; i++) { %>
                                                        <% var value='' ; if (hasDirectChildren(row.code)) {
                                                            value=getSumOfColumn(row.code, i); } else { value=row.values
                                                            && row.values[i] ? row.values[i] : '' ; } %>
                                                            <td>
                                                                <%= value %>
                                                            </td>
                                                            <% } %>
                                                                <td>
                                                                    <form method="GET" action="/">
                                                                        <input type="hidden" name="edit"
                                                                            value="<%= rowIndex %>">
                                                                        <input type="hidden" name="island"
                                                                            value="<%= island %>">
                                                                        <input type="hidden" name="sheet"
                                                                            value="<%= sheet %>">
                                                                        <button type="submit"
                                                                            class="btn btn-primary btn-sm">اصلاح</button>
                                                                    </form>
                                                                    <form method="POST" action="/delete-row"
                                                                        style="display:inline;"
                                                                        onsubmit="return confirmDelete(this);">
                                                                        <input type="hidden" name="island"
                                                                            value="<%= island %>">
                                                                        <input type="hidden" name="sheet"
                                                                            value="<%= sheet %>">
                                                                        <input type="hidden" name="rowIndex"
                                                                            value="<%= rowIndex %>">
                                                                        <button type="submit"
                                                                            class="btn btn-danger btn-sm">حذف</button>
                                                                    </form>
                                                                </td>
                                                </tr>
                                                <% } %>
                                                    <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>